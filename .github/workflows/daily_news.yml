name: Daily News CI

# Controls when the action will run. 
on:
  # Triggers the workflow twice a day on a schedule.
  # Note: GitHub Actions runners use UTC time. 
  # 22:00 UTC is 06:00 Beijing Time (UTC+8)
  # 10:00 UTC is 18:00 Beijing Time (UTC+8)
  schedule:
    - cron: "0 22 * * *"
    - cron: "0 10 * * *"

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch: 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Step 1: Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Python environment
      - name:  Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Step 3: Install system dependencies (Chromium for Selenium)
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-driver

      # Step 4: Install Python dependencies
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      # Step 5: Run News Pipeline
      - name: Run News Pipeline
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run:  |
          echo "Running news pipeline"
          python crawler/pipeline.py

      # Step 6: Deploy results to docs folder for GitHub Pages
      - name: Deploy results
        run: |
          # Use rsync to mirror output/ to docs/, effectively deleting old files in docs/
          # that are no longer in output/ (due to python cleanup script)
          rsync -av --delete --exclude='.git*' output/ docs/

      # Step 7: Commit and push the generated files
      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add docs/
          # Commit only if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Automated daily news update"
            # Pull latest changes to avoid conflicts
            git pull --rebase origin main
            git push origin main
          fi

